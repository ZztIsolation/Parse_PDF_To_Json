# 修复记录：跳过无效的第二章

## 📋 问题描述

### 现象
某些课程（如高等数学A2、线性代数等）的第二章虽然标题是"课程目标与毕业要求对应关系"，但内容明确说明"不做描述"或"各专业毕业要求各异"，实际上**没有**毕业要求对应关系表格。

然而，程序仍然会尝试提取这些章节，导致：
1. Level 1提取到0个表格
2. 触发Level 2（DeepSeek API）处理
3. Level 2也失败
4. 浪费时间和API调用

### 示例输出
```
======================================================================
📄 [19/124] 020_高等数学A2.md
======================================================================
      [1/4] 提取课程名称和代码...
      [2/4] 提取课程目标...
      [3/4] 提取毕业要求对应关系...
           Level 1: 找到 0 个表格
           ⚠️  Level 1解析失败，尝试Level 2（整章处理-DeepSeek）...
           ❌ Level 2仍然失败，保留Level 1结果
      [4/4] 提取课程联系...
      ✅ 成功保存: A0714202_高等数学 A2.json
```

### 实际内容
高等数学A2的第二章内容：
```
二、课程目标与毕业要求对应关系

作为面向全校多个专业的通识公共课程，因各专业毕业要求各异，此不做描述。
```

## 🔍 根本原因

`validate_chapter_2_title()` 函数只检查**标题**是否包含关键词，不检查**内容**是否真的包含有效数据。

### 原代码逻辑
```python
def validate_chapter_2_title(chapter_2_text: str) -> bool:
    # 只检查标题中是否包含关键词
    first_line = chapter_2_text.split('\n')[0]
    keywords = ['课程目标', '毕业要求', '对应关系']
    return all(keyword in first_line for keyword in keywords)
```

问题：
- ✅ 标题包含关键词 → 验证通过
- ❌ 但内容说明"不做描述" → 应该跳过

## ✅ 解决方案

增强 `validate_chapter_2_title()` 函数，增加三个验证步骤：

### 修改后的逻辑
```python
def validate_chapter_2_title(chapter_2_text: str) -> bool:
    """
    验证第二章是否是关于"课程目标与毕业要求对应关系"，并且包含实际内容
    """
    # 步骤1：检查标题中是否包含关键词
    first_line = chapter_2_text.split('\n')[0]
    keywords = ['课程目标', '毕业要求', '对应关系']
    if not all(keyword in first_line for keyword in keywords):
        return False
    
    # 步骤2：检查内容是否明确说明"不做描述"或"无"
    skip_patterns = [
        '不做描述',
        '此不做描述',
        '不作描述',
        '各专业毕业要求各异',
        '因各专业.*不做描述',
        '暂无',
        '^无$',
        '^无。$',
    ]
    
    content_after_title = '\n'.join(chapter_2_text.split('\n')[1:])[:200]
    
    for pattern in skip_patterns:
        if re.search(pattern, content_after_title):
            return False
    
    # 步骤3：检查是否包含表格标记（|符号）
    if '|' not in chapter_2_text:
        return False
    
    return True
```

## 🧪 测试结果

### 测试1：应该跳过的课程（数学类通识课）
```
📄 017_线性代数.md
   第二章标题: 二、 课程目标与毕业要求对应关系
   内容预览: 作为面向全校各专业的通识公共课程，因各专业毕业要求各异，故此不做描述。
   验证结果: ❌ 跳过（正确）✅

📄 018_概率论与数理统计.md
   第二章标题: 二、 课程目标与毕业要求对应关系
   内容预览: 作为面向全校多个专业的课程，因各专业毕业要求各异，故此不做描述。
   验证结果: ❌ 跳过（正确）✅

📄 019_高等数学A1.md
   第二章标题: 二、课程目标与毕业要求对应关系
   内容预览: 作为面向全校多个专业的通识公共课程，因各专业毕业要求各异，故此不做描述。
   验证结果: ❌ 跳过（正确）✅

📄 020_高等数学A2.md
   第二章标题: 二、课程目标与毕业要求对应关系
   内容预览: 作为面向全校多个专业的通识公共课程，因各专业毕业要求各异，此不做描述。
   验证结果: ❌ 跳过（正确）✅
```

### 测试2：应该提取的课程（包含真实表格）
```
📄 061_程序设计基础.md
   第二章标题: 二、 课程目标与毕业要求对应关系
   内容预览: 针对计算机科学与技术专业，《程序设计基础》支撑毕业要求...
   验证结果: ✅ 需要提取（正确）✅
```

## 📊 效果

### 修改前
- 对于无效章节：尝试Level 1 → 失败 → 尝试Level 2 → 失败
- 浪费时间：约10-15秒/课程
- 浪费API调用：每个无效章节调用1次DeepSeek API

### 修改后
- 对于无效章节：直接跳过，不尝试提取
- 节省时间：约10-15秒/课程
- 节省API调用：避免不必要的DeepSeek API调用

### 修改后（实际输出）
```
======================================================================
📄 [19/124] 020_高等数学A2.md
======================================================================
      [1/4] 提取课程名称和代码...
      [2/4] 提取课程目标...
      [3/4] 提取毕业要求对应关系...
      [4/4] 提取课程联系...
      ✅ 成功保存: A0714202_高等数学 A2.json
```

**注意**：第3步直接跳过，没有任何Level 1/Level 2的尝试！

## 📝 修改文件

- `src/process_markdown.py` - 增强 `validate_chapter_2_title()` 函数

## 🎯 影响范围

- ✅ 正面影响：跳过无效章节，节省时间和API调用
- ✅ 无副作用：包含真实表格的课程仍然正常提取
- ✅ 向后兼容：不影响其他功能

## 📅 修改日期

2025-11-08

